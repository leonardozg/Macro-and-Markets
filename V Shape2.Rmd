---
title: "Recent Financial Cycles- Statistical Features and Parameters"
author: "Leonardo Zepeda"
date: "20 Ene 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Abstract

By analyzing DOW and S&P indexes from 1980 to date, the author identifies 7 financial cycles and present common statistical features and parameters for each cycle. The analysis found that a cycle's length range from 764 to 1,777 days, averaging 20 basis points (bp) and 112 bp weekly and monthly returns respectively for DOW index; and 19 bp and 114 bp weekly and monthly returns respectively for S&P index. The analysis also found that cycle's total returns averaged 1.58 and 1.59 times it initial values for DOW and S&P indexes respectively, ranging from 1.38 to 1.81 times for both indexes.  

With the latest, and considering only statistical features, we could infer current cycle still have between 294 and 587 days left with the expectation to deliver at least 1.58 times its initial values, from which DOW has ran 91% of it already, and S&P has surpassed 2% above its peak already. The analysis also infers that negative returns will be the norm on a weekly and monthly basis and by now, this cycle present already more negative incidences than cycle's average, and also that that there is not a noticeable trend for immediate recovery after sensitive falls. However, at the end of the cycle, positive shots will compensate incidental losses.


[Code is available here](https://github.com/leonardozg/Macro-and-Markets/blob/master/V%20Shape2.Rmd)


## The Data

The data comes from Yahoo Finance, selecting the adjusted price column. These data correct the irregularities generated by idiosyncratic events of the firms that are not market movements (dividends, splits, etc.). Thus, the data are comparable over time. From them we create new columns: returns (daily percentage change), lagged price and lagged performance. Lagging performance is simply the performance of the previous day.


```{r echo=FALSE, message=FALSE, warning=FALSE}

    library(tidyverse)
    library(tidyquant)
    library(tibbletime)
    library(ggplot2)
    library(lubridate)
    library(matrixStats)
    library(data.table)
    library(dplyr)
    library(xts)
    library(zoo)
    library(TTR)
    library(quantmod)
    library(highcharter)
    library(timetk)
    library(cowplot)
```

```{r, echo=FALSE}
DOW  <- tq_get("^DJI", get = "stock.prices", from = "1980-01-01")
SP <- tq_get("^GSPC", get = "stock.prices", from = "1980-01-01")
```

Our objective is to find out critical statistical features to describe a cycle: length, weekly returns, monthly returns, total returns per cycle, and other technical (statistical) features and parameters useful for risk management.   

```{r, echo =FALSE}
df <- bind_rows("DOW" = DOW,"SP"= SP, .id = "index") %>% 
     select(date, index, adjusted) %>% 
     rename(price = adjusted)
```

## A First Visual Analysis

By observing historical levels we notice dramatic changes against certain dramatic events. More relevant and dramatic are 1987 crisis, 9/11 in 2001 and the sub-prime crisis in 2009 and more recently the dramatic COVID-19 crisis in 2020. Is also noticeable that indexes behave highly correlated over time.

### Graph I -Levels

```{r echo=FALSE}

ggplot(df, aes(date, price, colour=index)) + 
    geom_line(data=df %>% filter(index =="DOW")) + 
    geom_line(data=df %>% filter(index =="SP"), aes(y = price*10)) + 
    scale_y_continuous(sec.axis= sec_axis(~./10, name="SP")) +
    scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
```


### Leveling Perspective

Price's magnitude distract the observer from the size of the variations. By considering price levels of 2020 (around 30,000 points for DOW) the observer may perceive a reduced importance of price variations in say, 1987 (when prices of DOW were one-tenth of 2020 levels). By using returns we can focus in the magnitude of the change avoiding the distraction of increasing price levels. In order to filter only "sustained" variations, used returns are on weekly and monthly basis

### Graph II -Returns 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
df <- df %>% 
     group_by(index) %>% 
     mutate(lag_price = lag(price,5),
            returnw = (price - lag_price)/ lag_price,
            lag_returnw = lag(returnw)) %>%
     na.omit()

df <- df %>% 
     group_by(index) %>% 
     mutate(lag_price = lag(price,30),
            returnm = (price - lag_price)/ lag_price,
            lag_returnm = lag(returnm)) %>%
     na.omit()

lev1 <- df %>%
     ggplot(aes(x=date, y=returnw))+
     geom_line(aes(col=index))+
     geom_hline(yintercept=-.10, linetype="solid", 
                color = "black", size=0.2)+
     geom_hline(yintercept=.10, linetype="solid", 
                color = "black", size=0.2)+
    scale_color_manual(values=c("#999999", "#CA0020", "#404040"))



lev2 <- df %>%
     ggplot(aes(x=date, y=returnm))+
     geom_line(aes(col=index))+
     geom_hline(yintercept=-.20, linetype="solid", 
                color = "black", size=0.2)+
     geom_hline(yintercept=.20, linetype="solid", 
                color = "black", size=0.2)+
     scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

plot_grid (lev1, lev2, 
         labels = c("Weekly Returns", "Monthly Returns"),
         ncol = 2,nrow = 1)


```

## Is there a trend for sudden recovery ? 

One of the interesting aspects to analyze is to find out if there is a noticeable trend for recovery after sensitive falls. First we will analyze global patterns of recovery by plotting returns against lagged returns in weekly (7 days) and monthly basis (30 days). If immediate or abrupt recovery was a pattern, we should expect a more dense cloud of points in the higher-left corner of the graph, meaning that sensitive falls corresponds to sensitive recovery. As observed in following graph neither for DJI or S&P 500 and weekly nor monthly data suggest that it would be the case. 

###  Graph III -Recovery Paterns

```{r echo=FALSE, message=FALSE, warning=FALSE}

 t1 <- 
    ggplot(df, aes(x=lag_returnw, y=returnw))+ 
    geom_point(aes(col=index), alpha = 0.4)+
    geom_abline(intercept = 0, slope = 1, lty = 3, col=3)+
    xlim(-.3,.3)+
    ylim(-.3,.3)+
    scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
  


t2 <- 
   ggplot(df, aes(x=lag_returnm, y=returnm))+ 
    geom_point(aes(col=index), alpha = 0.4)+
    geom_abline(intercept = 0, slope = 1, lty = 3, col=3)+
    xlim(-.3,.3)+
    ylim(-.3,.3)+
    scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

plot_grid (t1, t2, 
         labels = c("Weekly Jumps", "Monthly Jumps"),
         ncol = 2,nrow = 1)

```

To validate the latest inference, we arrange data in "equally-sized volatility clusters" regardless of the time of occurrence. We arrange data in 100 equally sized groups. We call them Similar Volatility Groups. As a result from that arrangement, the first group will contain 1% of the smallest lagged returns, while the latest group will contain the 1% largest lagged returns. Then for each group we calculate its mean and the positive portion of each group. 

By filtering only current positive returns, we observe that the groups with the smallest returns correspond to negative mean lagged returns and the largest returns correspond to the largest positive lagged mean returns in asymptotycal line around the 0 mean. The latest complies for both weekly and monthly lagged returns. Up to now it might be confirmed that there is not a noticeable trend for recovery after sensitive falls.

Moreover, when plotting its density we find that there is sensitively more density of positive cases, within the 50% larger lagged returns. This may imply that the magnitude of the recovery is more often related with previous positive returns, than with sensitive falls. A momentum argument as commonly referred by traders. 


```{r, echo=FALSE, message=FALSE, warning=FALSE}
N <- 100

df_cutsw <- df %>%
            group_by(index) %>%
            mutate(bin = cut(lag_returnw, 
                                  quantile(lag_returnw, 
                                           probs = seq(1 / N, 1 - 1 / N, 1 / N))) %>%
                                  as.character()) %>%
            group_by(index, bin) %>%
            summarize(pos = mean(returnw >0 ),
                      mid = mean(lag_returnw)) 


df_cutsm <- df %>%
            group_by(index) %>%
            mutate(bin = cut(lag_returnm, 
                                  quantile(lag_returnm, 
                                           probs = seq(1 / N, 1 - 1 / N, 1 / N))) %>%
                                  as.character()) %>%
            group_by(index, bin) %>%
            summarize(pos = mean(returnm>0),
                      mid = mean(lag_returnm)) 

```


## Graph IV -Recovery Paterns in depth

```{r,  echo=FALSE}
tqw <- 
  ggplot(df_cutsw, aes(x=pos, y=mid))+
  geom_point(aes(col = index), alpha=0.5, size=1)+
  geom_hline(yintercept=0.00, col=2)+
  geom_vline(xintercept=0.50, col=2)+
  xlab("return group -positive portion")+
  ylab("mean of lag returns")+
  scale_color_manual(values=c("#999999", "#CA0020", "#404040"))


tqwd <- 
  ggplot() + geom_density(data=df_cutsw, aes(x=pos, group=index, color=index, ..count..), alpha=0, adjust=1)+
  theme_classic()+
  geom_vline(xintercept=0.50, col=1)+
  xlab("return group -positive portion")+
  ylab("count")+
  scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

tqm <- 
  ggplot(df_cutsm, aes(x=pos, y=mid))+
  geom_point(aes(col = index), alpha=0.5, size=1)+
  geom_hline(yintercept=0.00, col=2)+
  geom_vline(xintercept=0.50, col=2)+
  xlab("return group -positive portion")+
  ylab("mean of lag returns")+
  scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

tqmd <- 
  ggplot() + geom_density(data=df_cutsm, aes(x=pos, group=index, color=index,..count..), alpha=0, adjust=1)+
  theme_classic()+
  geom_vline(xintercept=0.50, col=1)+
  xlab("return group -positive portion")+
  ylab("count")+
  stat_bin()+
  scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

plot_grid (tqw, tqm, tqwd, tqmd, 
         labels = c("Weekly Returns Reaction", "Monthly Returns Reaction", "Weekly Ret Denisty", "Monthly Ret Density"),
         ncol = 2,nrow = 2)


```  



## Features of cyles

There are several methods and criteria to identify cycles.  Far from any theoretical stance and with a mere practical objective, in this analysis we define the start of a cycle with a threshold of a 10% or bigger daily fall, coincident with a 10% weekly and a 10% monthly fall in index prices. As arbitrary as it seems, it provides 7 coincident falls (for both indexes) from 1985 to 2021 (see Graph 2 and 3)

```{r, echo=FALSE}
dfa <- subset(df, df$returnd <-.1 & df$returnw < -.1 & df$returnm < -.1)
```

### Critical dates

|Date| Index |
|----------|----------|
|1987/10/19| DOW, S&P |
|1998/08/31| DOW, S&P |
|2001/09/17| DOW, S&P |
|2002/07/22| S&P |
|2008/10/07| DOW, S&P |
|2009/02/23| S&P |
|2011/08/08| DOW, S&P |
|2015/08/25| DOW, S&P |
|2020/02/27| DOW, S&P |
|----------|----------|

To identify a cycle we consider only critical dates coincident for both indexes what excludes: 2002/07/22 and 2009/02/23 from the S&P index.


### Length of Cycles

Cycle length is calculated by the number of days between one 10%+ (daily, weekly and monthly) coincident fall and the next one in occurrence. Length cycle is represented in Graph V. Please note that since the start date of series is arbitrary, cycle one for both index are not consistent. Also please note that cycle 7 is at early stage. 

Considering the latest we have 5 cycles to analyze. Graph 4 includes an horizontal line in 1081 days, representing the mean of cycles length of the 5 analyzed (complete) cycles. 

```{r, echo=FALSE}
df$cycle <- ifelse(df$date > as.Date("2020/02/27"),7, ifelse(df$date > as.Date("2015/08/25"),6 , ifelse(df$date  > as.Date("2011/08/08"), 5, ifelse(df$date  > as.Date("2008/10/07"), 4, ifelse(df$date > as.Date("2001/09/17"), 3, ifelse(df$date  > as.Date("1998/08/31"), 2,  1 ))))))

df <- df %>%
  group_by(index, cycle) %>%
  arrange(index,.by_group=TRUE) %>%
  mutate(days =row_number())

l <- as.data.frame(tapply(df$days,list(df$cycle,df$index), max))
 l <- l %>%  mutate (cycle = rownames(l)) 
 l <- l %>% select("cycle", "DOW", "SP")

```

### Graph V -Length of Cycles  

```{r, echo=FALSE}
l %>% 
  gather("Type", "Value", -cycle) %>%
  ggplot(aes(cycle, Value, fill= Type))+
  geom_bar(position="dodge", stat= "identity")+
  ylab("days")+
  geom_hline(yintercept=mean(l[2:6,]$DOW), linetype="solid", 
                color = "black", size=0.2)+
  scale_fill_manual(values=c("#999999", "#CA0020", "#404040"))

```

### Potential Return of Cycles

Maximum Return of each cycle is calculated with the highest normalized return reached by each index per each cycle. As noted in graph VI cycles are slightly above its average of 1.583 times its initial level being cycles 5 and 6 the highest with 1.63 and 1.81 for DOW and average of 1.599 and range from 1.82 and 1.74 for S&P.Current cycle stands already in 1.257 for Dow and 1.3319 for S&P. So despite is still quite short in time is has already run most of its potential return.    

### Graph VI  -Potential Return of Cycles 

```{r, echo =FALSE}
eDOW <- filter(df, index=="DOW" & days==1)
eDOW <- eDOW[, c(3,9)]
eDOW <- eDOW %>% select("cycle", "price")
 
eSP <- filter(df, index=="SP" & days==1)
eSP <- eSP[, c(3,9)]
eSP <- eSP %>% select("cycle", "price")

df <- df %>%
  group_by(index, cycle) %>%
  arrange(index,.by_group=TRUE) %>%
  mutate( norm= price/price[days==1][1L])

l1 <- as.data.frame(tapply(df$norm,list(df$cycle,df$index), max))
 l1 <- l1 %>%  mutate (cycle = rownames(l1)) 
 l1 <- l1 %>% select("cycle", "DOW", "SP")

l1 %>% 
  gather("Type", "Value", -cycle) %>%
  ggplot(aes(cycle, Value, fill= Type))+
  geom_bar(position="dodge", stat= "identity")+
  ylab("norm")+
  geom_hline(yintercept=mean(l1[2:6,]$DOW), linetype="solid", 
                color = "black", size=0.2)+
  scale_fill_manual(values=c("#999999", "#CA0020", "#404040"))

```


### Graph VII -Cycles 

```{r, echo=FALSE}

p1 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==2)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==2)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
         scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
p2 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==3)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==3)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
         scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
p3 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==4)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==4)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
         scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
p4 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==5)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==5)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
        scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
p5 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==6)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==6)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
         scale_color_manual(values=c("#999999", "#CA0020", "#404040"))
p6 <- ggplot(df, aes(days, norm, colour=index)) + 
         geom_line(data=df %>% filter(index== "DOW" & cycle ==7)) + 
         geom_line(data=df %>% filter(index== "SP" & cycle ==7)) +
         geom_hline(yintercept=1.00 , linetype="solid", 
                color = "black", size=0.2)+
         scale_color_manual(values=c("#999999", "#CA0020", "#404040"))

plot_grid (p1, p2, p3, p4, p5, p6, 
         labels = c("1998-2001", "2001-2008", "2008-2011", "2011-2015", "2015-2020","2020-TD"),
         ncol = 2,nrow = 3)
       
```


### Weekly Returns -Descriptive statistics per cycle 

Besides length of the cycle, central tendency analysis may reveal another important features. Every cycle present different weekly features regarding mean returns, volatility (standard deviation), skewness, and kurtosis. All this features are represented in the following graphs and tables. 


### Graph VIII -Weekly Returns -Distribution of returns

```{r, echo=FALSE}
ggplot(data=df, aes(x=returnw, group=cycle)) +
  geom_density(alpha=0.7, adjust=1) +
  facet_wrap(~cycle)+
  geom_vline(xintercept=0, linetype="solid", color ="#CA0020" , size=0.2)
  
 
```

Remembering statistics: if the skewness is between -0.5 and 0.5, the data are fairly symmetrical. If the skewness is between -1 and – 0.5 or between 0.5 and 1, the data are moderately skewed. If the skewness is less than -1 or greater than 1, the data are highly skewed.Negative values for the skewness indicate data that are skewed left and positive values for the skewness indicate data that are skewed right. By skewed left, we mean that the left tail (negative returns incidence) is long relative to the right tail (positive returns incidence). A positive mean with a negative skew, means negative incidence but not enough to deliver a negative mean, in other words, fewer cases are highly positive. In terms of kurtosis, what we should consider is how the incidence falls far from 0. When kurtosis is above 1, we may conclude most incidence falls near 0, but far from normal shape distribution.

For DOW weekly performance, means for all cycles are positive (20.2 basis points on average) with a standard deviation below 2.5%. However the incidences delivers a sensitive negative skewness of 0.55 and kurtosis far above 1.0 in most cases with exception of cycle 2.

For S&P weekly performance, means for all cycles are positive (19.96 basis points on average) with a standard deviation below 2.6%. However the incidences delivers a sensitive  negative skewness of 0.63 and kurtosis far above 1.0 in most cases with exception (again) of cycle 2.


```{r, echo=FALSE, results= "asis"}
s1 <- as.data.frame(tapply(df$returnw,list(df$cycle,df$index), mean)*10000)
s2 <- as.data.frame(tapply(df$returnw,list(df$cycle,df$index), sd))
s3 <- as.data.frame(tapply(df$returnw,list(df$cycle,df$index), skewness))
s4 <- as.data.frame(tapply(df$returnw,list(df$cycle,df$index), kurtosis))
DOWs <- cbind(l$DOW, s1$DOW, s2$DOW, s3$DOW, s4$DOW)
rownames(DOWs) <- rownames(l)
colnames(DOWs) <- c("days", "mean(bp)", "sd", "skewness", "kurosis")
SPs <- cbind(l$SP, s1$SP, s2$SP, s3$SP, s4$SP)
rownames(SPs) <- rownames(l)
colnames(SPs) <- c("days", "mean(bp)", "sd", "skewness", "kurosis")

DOWs <- as.data.frame(DOWs)
SPs <- as.data.frame(SPs)

knitr::kable(DOWs, caption="DOW Cycles Weekly statistical features")
knitr::kable(SPs, caption= "S&P Cycles Weekly statistical features")

```

### Monthly Returns 


### Monthly Returns -Descriptive statistics per cycle, 

Besides length of the cycle, central tendency analysis may reveal another important features. Every cycle present different monthly features regarding mean returns, its volatility (standard deviation), its skewness, and kurtosis. All this features are represented in the following graph and tables. 

### Graph IX -Distribution of returns

```{r, echo=FALSE}
ggplot(data=df, aes(x=returnm, group=cycle)) + 
  geom_density(alpha=0.8, adjust=3)+
  facet_wrap(~cycle)+
  geom_vline(xintercept=0, linetype="solid", color ="#CA0020" , size=0.2)
```

For DOW monthly performance, means for all cycles are positive (112 basis points on average) with a standard deviation below 5.5%. However the incidences delivers a sensitive  negative skewness of 0.68 and kurtosis above 1.0 (peaked shape with more incidence close to 0) in 4 of the 7 cycles, and below 1.0 (flattened shape and more disperse incidence) in 3 of the seven cases.

For S&P monthly performance, means for all cycles are positive (114 basis points on average) with a standard deviation below 5.7%. However the incidences delivers a sensitive  negative skewness of 0.80 and kurtosis far above 1.0 (peaked shape with more incidence close to 0) in 5 of the 7 cycles, and below 1.0 (flattened shape and more disperse incidence) in 2 of the seven cases.


```{r, echo=FALSE, results= "asis"}
s1m <- as.data.frame(tapply(df$returnm,list(df$cycle,df$index), mean)*10000)
s2m <- as.data.frame(tapply(df$returnm,list(df$cycle,df$index), sd))
s3m <- as.data.frame(tapply(df$returnm,list(df$cycle,df$index), skewness))
s4m <- as.data.frame(tapply(df$returnm,list(df$cycle,df$index), kurtosis))
DOWsm <- cbind(l$DOW, s1m$DOW, s2m$DOW, s3m$DOW, s4m$DOW)
rownames(DOWsm) <- rownames(l)
colnames(DOWsm) <- c("days", "mean(bp)", "sd", "skewness", "kurosis")
SPsm <- cbind(l$SP, s1m$SP, s2m$SP, s3m$SP, s4m$SP)
rownames(SPsm) <- rownames(l)
colnames(SPsm) <- c("days", "mean(bp)", "sd", "skewness", "kurosis")

DOWsm <- as.data.frame(DOWsm)
SPsm <- as.data.frame(SPsm)

knitr::kable(DOWsm, caption = "DOW Cycles Monthly statistical features")
knitr::kable(SPsm, caption = "S&P Cycles Monthly statistical features")

```

### Negative Incidence

As described in the previous section we must expect negative skew which means more negative hits (compared with its initial level) in both weekly and monthly returns. With that in mind we try to find negative patterns.  

The following graph shows the number of days with negative returns and the portion those represent of the length cycle. 

For the graph on the left, the horizontal lines are the cycles' average negative days for DOW (89.28 days) and S&P (118.14 days). Current cycle has had 59 and 52 negative days for DOW and S&P respectively, which means we could expect at least another 30 and 66 negative days respectively. 

In terms of percentage, (the graph on the right) the horizontal lines are the cycles' average percentage of negative days for DOW (9.12%) and S&P (9.76%). However is clear also that the longer the cycle, the highest percentage of negative days (cycles above 700 days). Current cycle has had 12.04% and 10.6% of negative days for DOW and S&P respectively, which means we could expect a sensitive decrease of that percentage in the remaining length of the cycle, also aS seen and described in Graphs I and IV, negative returns tend to come together in "inner cycles" or momentum.

### Graph X -Negative Incidence

```{r, echo=FALSE, warning=FALSE, message= FALSE}
neg <- as.data.frame(tapply(df$norm<1 ,list(df$cycle,df$index), count))
neg <- neg %>% mutate( cycle= rownames(neg))
negP <- cbind(as.data.frame(neg$DOW*100/l$DOW), as.data.frame(neg$SP*100/l$SP))
names(negP) <- c("DOW","SP")
negP <- negP %>% mutate( cycle= rownames(neg))

neg = gather(neg, key = var, value = value, DOW, SP)
negg <- ggplot(neg, aes(x = cycle, y = value, fill = var)) +
  geom_bar(stat = 'identity', position = 'dodge')+
  geom_hline(yintercept=mean(neg[neg$var=="DOW",3]), linetype="solid", 
                color ="#404040", size=0.2)+
  geom_hline(yintercept=mean(neg[neg$var=="SP",3]), linetype="solid", 
                color = "#CA0020", size=0.2)+
  scale_fill_manual(values=c("#999999", "#CA0020", "#404040"))
 
  

negP = gather(negP, key = var, value = value, DOW, SP)
neggp <- ggplot(negP, aes(x = cycle, y = value, fill = var)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_hline(yintercept=mean(negP[neg$var=="DOW",3]), linetype="solid", 
                color =  "#404040", size=0.2)+
  geom_hline(yintercept=mean(negP[negP$var=="SP",3]), linetype="solid", 
                color = "#CA0020", size=0.2)+
  scale_fill_manual(values=c("#999999", "#CA0020", "#404040"))

plot_grid (negg, neggp, 
         labels = c("days of neg returns", "% of days"),
         ncol = 2,nrow = 1)



```

### Conclusion

The analysis found that a cycle's length range from 714 to 1,777 days, averaging 20 basis points (bp) and 113 bp weekly and monthly returns respectively for DOW index; and 20 bp and 114 bp weekly and monthly returns respectively for S&P index. The analysis also found that cycle's total returns averaged 1.58 and 1.59 times it initial values for DOW and S&P indexes respectively, ranging from 1.38 to 1.81 times for both indexes. 

With the latest, and considering only statistical features, we could infer current cycle still have between 294 and 587 days left with the expectation to deliver at least 1.58 times its initial values, from which DOW has ran 91% of it already, and S&P has surpassed 2% above its peak already. The analysis also infers that negative returns will be the norm on a weekly and monthly basis and by now, this cycle present already more negative incidences than cycle's average, and also that that there is not a noticeable trend for immediate recovery after sensitive falls. However, at the end of the cycle, positive shots will compensate incidental losses.  

```{r, echo=FALSE, warning=FALSE, message= FALSE}
#Achieve <- tapply(df$norm, list(df$index, df$cycle), FUN=max)
#Achieve <- Achieve[, c(2:6)]
````




